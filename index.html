<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student App • GAS + Sheets</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style> body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; } </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-xl shadow p-6 space-y-6">
    <h1 class="text-2xl font-bold">Student App → Google Sheet</h1>

    <script>
      // === GAS_URL TẠM (hãy thay bằng URL của bạn) ===
      const GAS_URL = "https://script.google.com/macros/s/AKfycbx_DEMO_PLACEHOLDER/exec";
    </script>

    <!-- AUTH PANEL -->
    <section class="space-y-4 border rounded-lg p-4">
      <h2 class="text-xl font-semibold">Đăng nhập bằng mã (teacher/manager)</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Mã (code)</label>
          <input id="codeInput" class="w-full border rounded px-3 py-2" placeholder="TEA-1A2B">
        </div>
        <div>
          <label class="block text-sm mb-1">Email</label>
          <input id="emailInput" class="w-full border rounded px-3 py-2" placeholder="you@example.com">
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Tên hiển thị</label>
          <input id="displayNameInput" class="w-full border rounded px-3 py-2" placeholder="Nguyễn Văn A (tùy chọn)">
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button id="btnLogin" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Đăng nhập</button>
        <span id="authMsg" class="text-sm"></span>
      </div>

      <!-- Nếu code chưa có, hiện khối thêm mới -->
      <div id="regBox" class="hidden border-t pt-4 mt-2">
        <h3 class="font-semibold mb-2">Chưa có mã? Thêm mới:</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm mb-1">Mã (code)</label>
            <input id="regCode" class="w-full border rounded px-3 py-2">
          </div>
          <div>
            <label class="block text-sm mb-1">Role</label>
            <select id="regRole" class="w-full border rounded px-3 py-2">
              <option value="teacher">teacher</option>
              <option value="manager">manager</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input id="regEmail" class="w-full border rounded px-3 py-2">
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm mb-1">Tên hiển thị</label>
            <input id="regDisplayName" class="w-full border rounded px-3 py-2">
          </div>
        </div>
        <div class="flex items-center gap-3 mt-3">
          <button id="btnAddCode" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Thêm mã</button>
          <span id="regMsg" class="text-sm"></span>
        </div>
      </div>

      <div id="meBox" class="hidden text-sm text-gray-700">
        <div class="mt-2">Đã đăng nhập: <span id="meInfo" class="font-medium"></span></div>
        <button id="btnLogout" class="mt-2 border px-3 py-1 rounded hover:bg-gray-50">Đăng xuất</button>
      </div>
    </section>

    <!-- CREATE RECORD (chỉ hiện khi đã login) -->
    <section id="createBox" class="hidden space-y-3 border rounded-lg p-4">
      <h2 class="text-xl font-semibold">Thêm bản ghi lớp</h2>
      <form id="createForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Class Code <span class="text-red-500">*</span></label>
          <input id="classCode" class="w-full border rounded px-3 py-2" placeholder="TEA-1A2B" required>
        </div>
        <div>
          <label class="block text-sm mb-1">Student Name <span class="text-red-500">*</span></label>
          <input id="studentName" class="w-full border rounded px-3 py-2" placeholder="Nguyễn Văn A" required>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm mb-1">Note</label>
          <input id="note" class="w-full border rounded px-3 py-2" placeholder="Ghi chú...">
        </div>
        <div class="md:col-span-2 flex items-center gap-3">
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Lưu</button>
          <span id="msgCreate" class="text-sm"></span>
        </div>
      </form>
    </section>

    <!-- LIST -->
    <section class="space-y-3 border rounded-lg p-4">
      <div class="flex items-center gap-3">
        <h2 class="text-xl font-semibold">Danh sách</h2>
        <input id="filterClassCode" class="border rounded px-3 py-2" placeholder="Lọc theo classCode (vd TEA-1A2B)">
        <button id="reloadBtn" class="bg-gray-800 text-white px-3 py-2 rounded hover:bg-black">Tải lại</button>
      </div>
      <div class="overflow-auto">
        <table class="min-w-full border">
          <thead class="bg-gray-50">
            <tr>
              <th class="border px-3 py-2 text-left">timestamp</th>
              <th class="border px-3 py-2 text-left">teacherEmail</th>
              <th class="border px-3 py-2 text-left">classCode</th>
              <th class="border px-3 py-2 text-left">studentName</th>
              <th class="border px-3 py-2 text-left">note</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // -------- helpers --------
    function setToken(t){ localStorage.setItem('sessionToken', t||''); }
    function getToken(){ return localStorage.getItem('sessionToken') || ''; }
    function fmtDate(v){ try{ return new Date(v).toLocaleString(); }catch(e){ return v||''; } }

    async function apiPost(body){
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return res.json();
    }
    async function apiGet(params){
      const url = new URL(GAS_URL);
      if (params) Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
      const res = await fetch(url.toString());
      return res.json();
    }

    // -------- auth flows --------
    async function loginWithCode(code, email){
      return apiPost({ action:'loginWithCode', code, email });
    }
    async function verifyToken(token){
      // dùng GET để dễ test nhanh
      return apiGet({ action:'verifyToken', token });
    }
    async function addCode(code, role, email, displayName){
      return apiPost({ action:'addCode', code, role, email, displayName });
    }

    // -------- data flows --------
    async function createRecord(token, { classCode, studentName, note }){
      return apiPost({ action:'createRecord', token, classCode, studentName, note });
    }
    async function fetchList(classCode){
      return apiGet(classCode ? { classCode } : null);
    }
    function renderRows(rows){
      const tb = document.getElementById('tbody'); tb.innerHTML = '';
      for (const r of (rows||[])){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-3 py-2">${fmtDate(r.timestamp)}</td>
          <td class="border px-3 py-2">${r.teacherEmail||''}</td>
          <td class="border px-3 py-2">${r.classCode||''}</td>
          <td class="border px-3 py-2">${r.studentName||''}</td>
          <td class="border px-3 py-2">${r.note||''}</td>
        `;
        tb.appendChild(tr);
      }
    }

    // -------- UI bind --------
    const authMsg = document.getElementById('authMsg');
    const regBox  = document.getElementById('regBox');
    const regMsg  = document.getElementById('regMsg');
    const meBox   = document.getElementById('meBox');
    const meInfo  = document.getElementById('meInfo');
    const createBox = document.getElementById('createBox');

    function showLoggedIn(payload){
      meBox.classList.remove('hidden');
      createBox.classList.remove('hidden');
      const s = `${payload.displayName||payload.email||payload.code||''} • role: ${payload.role||''}`;
      meInfo.textContent = s;
      authMsg.textContent = '✅ Đăng nhập thành công';
      regBox.classList.add('hidden');
    }
    function showLoggedOut(){
      meBox.classList.add('hidden');
      createBox.classList.add('hidden');
      authMsg.textContent = '';
      regBox.classList.add('hidden');
    }

    document.getElementById('btnLogin').addEventListener('click', async ()=>{
      const code = document.getElementById('codeInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      authMsg.textContent = 'Đang đăng nhập...';
      try{
        const r = await loginWithCode(code, email);
        if (r.success){
          setToken(r.token);
          showLoggedIn(r.payload);
        } else if (r.notFound) {
          authMsg.textContent = '❗ Code chưa tồn tại. Bạn có thể thêm mới ở bên dưới.';
          // prefill reg inputs
          document.getElementById('regCode').value = code;
          document.getElementById('regEmail').value = email;
          document.getElementById('regDisplayName').value = document.getElementById('displayNameInput').value.trim();
          regBox.classList.remove('hidden');
        } else {
          authMsg.textContent = '❌ ' + (r.message||'Đăng nhập thất bại');
        }
      }catch(err){
        authMsg.textContent = '❌ ' + err.message;
      }
    });

    document.getElementById('btnAddCode').addEventListener('click', async ()=>{
      const code = document.getElementById('regCode').value.trim();
      const role = document.getElementById('regRole').value;
      const email = document.getElementById('regEmail').value.trim();
      const displayName = document.getElementById('regDisplayName').value.trim();
      regMsg.textContent = 'Đang thêm mã...';
      try{
        const r = await addCode(code, role, email, displayName);
        if (r.success){
          regMsg.textContent = '✅ Đã thêm. Giờ bạn có thể bấm Đăng nhập.';
        } else {
          regMsg.textContent = '❌ ' + (r.message||'Không thêm được');
        }
      }catch(err){
        regMsg.textContent = '❌ ' + err.message;
      }
    });

    document.getElementById('btnLogout').addEventListener('click', ()=>{
      setToken('');
      showLoggedOut();
    });

    document.getElementById('createForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const token = getToken();
      const classCode = document.getElementById('classCode').value.trim();
      const studentName = document.getElementById('studentName').value.trim();
      const note = document.getElementById('note').value.trim();
      const msg = document.getElementById('msgCreate');
      msg.textContent = 'Đang lưu...';
      try{
        const r = await createRecord(token, { classCode, studentName, note });
        if (r.success){
          msg.textContent = '✅ Lưu thành công';
          // refresh list theo filter
          const filter = document.getElementById('filterClassCode').value.trim();
          const data = await fetchList(filter);
          renderRows(data.data||[]);
        } else {
          msg.textContent = '❌ ' + (r.message||'Lỗi không rõ');
        }
      }catch(err){
        msg.textContent = '❌ ' + err.message;
      }
    });

    document.getElementById('reloadBtn').addEventListener('click', async ()=>{
      const filter = document.getElementById('filterClassCode').value.trim();
      const data = await fetchList(filter);
      renderRows(data.data||[]);
    });

    // -------- boot --------
    (async ()=>{
      // verify token nếu có
      const token = getToken();
      if (token){
        try{
          const r = await verifyToken(token);
          if (r.success) showLoggedIn(r.payload); else showLoggedOut();
        }catch{ showLoggedOut(); }
      } else {
        showLoggedOut();
      }
      // load list lần đầu
      const data = await fetchList();
      renderRows(data.data||[]);
    })();
  </script>
</body>
</html>
