<!DOCTYPE html>


<hr class="my-6" />
<div class="text-xs text-gray-400 text-center">
  Trang này gọi <code>/api/gas-proxy</code> (Vercel) → Apps Script. Không cần định dạng TEA-/MGR-.
</div>
</div>


<script>
  const DASHBOARD_TEACHER = "/teacher.html";
  const DASHBOARD_MANAGER = "/manager.html";


  const $ = (s) => document.querySelector(s);
  const alertEl = () => $("#alert");


  function showAlert(msg, type = "error") {
    const el = alertEl();
    el.className = "mb-4 p-3 rounded-lg text-sm ";
    if (type === "success") el.className += "bg-green-50 text-green-700 border border-green-200";
    else el.className += "bg-red-50 text-red-700 border border-red-200";
    el.textContent = msg;
  }
  function hideAlert() { alertEl().className = "hidden"; }


  function saveSession({ token, role, code, email, displayName }) {
    const payload = { token, role, code, email, displayName, ts: Date.now() };
    sessionStorage.setItem("session", JSON.stringify(payload));
  }
  function gotoDashboard(role) {
    window.location.href = role === 'manager' ? DASHBOARD_MANAGER : DASHBOARD_TEACHER;
  }


  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlert();
    const code = String(document.getElementById('userCode').value || '').trim();
    if (!code) return showAlert('Vui lòng nhập mã người dùng.');
    try {
      const res = await fetch('/api/gas-proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'loginWithCode', code })
      });
      if (!res.ok) throw new Error('Fetch failed ' + res.status);
      const data = await res.json();
      if (!data.success) return showAlert(data.message || 'Đăng nhập thất bại');
      saveSession({ token: data.token, role: data.role, code, email: data.email, displayName: data.displayName });
      showAlert('Đăng nhập thành công! Đang chuyển trang...', 'success');
      setTimeout(() => gotoDashboard(data.role), 300);
    } catch (err) {
      console.error(err);
      showAlert('Không thể kết nối máy chủ. Kiểm tra proxy và Apps Script.');
    }
  });


  // Nếu đã đăng nhập thì chuyển luôn
  (function auto() {
    try {
      const s = JSON.parse(sessionStorage.getItem('session') || 'null');
      if (s && s.token && s.role) gotoDashboard(s.role);
    } catch { }
  })();
</script>
</body>

</html>