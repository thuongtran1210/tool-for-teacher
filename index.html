<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sheets CRUD — Static + Tailwind</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','ui-sans-serif','system-ui'] }
        }
      }
    }
  </script>
  <style> body { font-family: Inter, ui-sans-serif, system-ui; } </style>

  <script>
    // ==== ĐIỀN URL Web App GAS của bạn: ====
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxzBJYmqMVa75OzBrTOTQeRtoK9aPYevGQjvSkoXy9lzcmisEOd00Qi_2udemy-07WD/exec";

    // ===== Helpers =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const toast = (msg, type='info') => {
      const el = $('#toast'); el.textContent = msg;
      el.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow text-white transition
        ${type==='error'?'bg-red-600':'bg-emerald-600'}`;
      el.style.opacity = 1;
      setTimeout(()=> el.style.opacity = 0, 2200);
    };

    // ===== API calls =====
    async function apiList() {
      const r = await fetch(`${GAS_URL}?action=list`, { method:'GET' });
      return r.json();
    }
    async function apiCreate(payload) {
      const r = await fetch(GAS_URL, {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action:'create', ...payload })
      });
      return r.json();
    }
    async function apiUpdate(payload) {
      const r = await fetch(GAS_URL, {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action:'update', ...payload })
      });
      return r.json();
    }
    async function apiDelete(id) {
      const r = await fetch(GAS_URL, {
        method:'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action:'delete', id })
      });
      return r.json();
    }
    async function apiSearch(q) {
      const r = await fetch(`${GAS_URL}?action=search&q=${encodeURIComponent(q)}`);
      return r.json();
    }

    // ===== UI Logic =====
    async function refreshList(q = '') {
      $('#loading').classList.remove('hidden');
      try {
        const data = q ? await apiSearch(q) : await apiList();
        const rows = (data.data || []);
        const tbody = $('#tbody');
        tbody.innerHTML = rows.map(r => `
          <tr class="border-b last:border-0">
            <td class="px-3 py-2 text-sm text-gray-600">${r.id}</td>
            <td class="px-3 py-2">
              <input type="text" value="${escapeHtml(r.name)}" 
                     class="w-full border rounded-md px-2 py-1 text-sm"
                     data-field="name" data-id="${r.id}">
            </td>
            <td class="px-3 py-2">
              <input type="text" value="${escapeHtml(r.note)}" 
                     class="w-full border rounded-md px-2 py-1 text-sm"
                     data-field="note" data-id="${r.id}">
            </td>
            <td class="px-3 py-2 text-xs text-gray-500">${r.updatedAt || ''}</td>
            <td class="px-3 py-2 text-right">
              <button class="px-3 py-1 bg-emerald-600 text-white rounded-md text-sm"
                      onclick="onSave(${r.id})">Lưu</button>
              <button class="ml-2 px-3 py-1 bg-red-600 text-white rounded-md text-sm"
                      onclick="onDelete(${r.id})">Xóa</button>
            </td>
          </tr>
        `).join('');
        $('#count').textContent = rows.length;
      } catch (e) {
        console.error(e); toast('Lỗi tải dữ liệu', 'error');
      } finally {
        $('#loading').classList.add('hidden');
      }
    }

    function escapeHtml(s='') {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    async function onCreate(e) {
      e.preventDefault();
      const name = $('#name').value.trim();
      const note = $('#note').value.trim();
      if (!name) { toast('Vui lòng nhập tên','error'); return; }
      const res = await apiCreate({ name, note });
      if (res.success) {
        $('#name').value = ''; $('#note').value = '';
        toast('Đã thêm bản ghi');
        refreshList($('#search').value.trim());
      } else toast(res.message || 'Không thể tạo', 'error');
    }

    async function onSave(id) {
      const name = $(`input[data-field="name"][data-id="${id}"]`).value.trim();
      const note = $(`input[data-field="note"][data-id="${id}"]`).value.trim();
      const res = await apiUpdate({ id, name, note });
      if (res.success) {
        toast('Đã lưu');
        refreshList($('#search').value.trim());
      } else toast(res.message || 'Không thể lưu', 'error');
    }

    async function onDelete(id) {
      if (!confirm(`Xóa bản ghi #${id}?`)) return;
      const res = await apiDelete(id);
      if (res.success) {
        toast('Đã xóa');
        refreshList($('#search').value.trim());
      } else toast(res.message || 'Không thể xóa', 'error');
    }

    let searchDebounce;
    function onSearchInput() {
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(() => {
        const q = $('#search').value.trim();
        refreshList(q);
      }, 300);
    }

    window.addEventListener('DOMContentLoaded', () => {
      refreshList();
      $('#createForm').addEventListener('submit', onCreate);
      $('#search').addEventListener('input', onSearchInput);
    });
  </script>
</head>

<body class="bg-gray-50 min-h-screen">
  <div id="toast" style="opacity:0"></div>

  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="mb-6 flex items-center justify-between gap-3">
      <h1 class="text-2xl sm:text-3xl font-bold">Google Sheets CRUD (Static + Tailwind)</h1>
      <a class="text-xs text-gray-500 underline" target="_blank" rel="noreferrer"
         href="https://script.google.com/">Apps Script</a>
    </header>

    <!-- Create -->
    <form id="createForm" class="bg-white rounded-xl shadow p-4 sm:p-5 border border-gray-200 mb-5">
      <div class="flex flex-col sm:flex-row gap-3">
        <input id="name" placeholder="Tên" class="flex-1 border rounded-md px-3 py-2" />
        <input id="note" placeholder="Ghi chú" class="flex-1 border rounded-md px-3 py-2" />
        <button class="px-4 py-2 bg-blue-600 text-white rounded-md">Thêm</button>
      </div>
      <p class="text-xs text-gray-500 mt-2">
        Thay GAS_URL ở phần &lt;script&gt; để kết nối Web App của bạn.
      </p>
    </form>

    <!-- Toolbar -->
    <div class="flex items-center justify-between mb-2">
      <div class="flex items-center gap-2">
        <input id="search" placeholder="Tìm theo tên/ghi chú…" 
               class="border rounded-md px-3 py-2 w-64 max-w-full" />
        <span id="loading" class="hidden text-sm text-gray-500">Đang tải…</span>
      </div>
      <div class="text-sm text-gray-600">Số bản ghi: <span id="count">0</span></div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-xl shadow border border-gray-200 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="text-left px-3 py-2 font-semibold">ID</th>
            <th class="text-left px-3 py-2 font-semibold">Tên</th>
            <th class="text-left px-3 py-2 font-semibold">Ghi chú</th>
            <th class="text-left px-3 py-2 font-semibold">Cập nhật</th>
            <th class="text-right px-3 py-2 font-semibold">Thao tác</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer class="mt-8 text-xs text-gray-500">
      * Nếu bị chặn CORS khi gọi trực tiếp, hãy đặt một proxy server nhỏ (Next.js API) để gọi GAS server-side.
    </footer>
  </div>
</body>
</html>
